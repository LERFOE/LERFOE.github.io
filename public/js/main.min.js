class RibooApp{constructor(){this.init()}init(){this.createParticles(),this.setupCardInteractions(),this.setupModal(),this.setupSearch(),this.setupTOC()}createParticles(){const e=document.querySelector(".bg-particles");if(!e)return;const t=50;for(let s=0;s<t;s++){const n=document.createElement("div");n.className="particle",n.style.left=Math.random()*100+"%",n.style.animationDelay=Math.random()*20+"s",n.style.animationDuration=15+Math.random()*10+"s",n.style.opacity=Math.random()*.5+.1,e.appendChild(n)}}setupCardInteractions(){const e=document.querySelectorAll(".post-card");e.forEach(e=>{e.addEventListener("mouseenter",t=>{this.createCardGlow(t,e)}),e.addEventListener("mouseleave",t=>{this.removeCardGlow(e)}),e.addEventListener("mousemove",t=>{this.updateCardReflection(t,e)}),e.addEventListener("click",()=>{const t=e.dataset.post;this.openArticleModal(t)})})}createCardGlow(e,t){const n=t.querySelector(".card-glow");n&&(n.style.opacity="1")}removeCardGlow(e){const t=e.querySelector(".card-glow");t&&(t.style.opacity="0")}updateCardReflection(e,t){const n=t.getBoundingClientRect(),i=e.clientX-n.left,a=e.clientY-n.top,s=n.width/2,o=n.height/2,r=(i-s)/s,c=(a-o)/o;t.style.transform=`
            perspective(1000px) 
            rotateX(${c*5}deg) 
            rotateY(${r*5}deg) 
            translateZ(10px)
        `}setupModal(){if(this.modal=document.getElementById("article-modal"),this.modalContent=document.querySelector(".modal-content"),this.modalClose=document.getElementById("modal-close"),this.articleContent=document.getElementById("article-content"),!this.modal)return;this.modalClose.addEventListener("click",()=>{this.closeArticleModal()}),this.modal.addEventListener("click",e=>{e.target===this.modal&&this.closeArticleModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.modal.classList.contains("active")&&this.closeArticleModal()})}async openArticleModal(e){try{const s=await fetch(`/posts/${e}/index.html`),o=await s.text(),i=new DOMParser,t=i.parseFromString(o,"text/html"),n=t.querySelector(".post-content")||t.body;this.articleContent.innerHTML=n.innerHTML,this.generateTOC(n),this.modal.classList.add("active"),setTimeout(()=>{this.modalContent.style.transform="perspective(1000px) rotateY(0deg) scale(1)"},50),document.body.style.overflow="hidden"}catch(e){console.error("加载文章失败:",e),this.articleContent.innerHTML="<p>加载文章失败，请稍后重试。</p>",this.modal.classList.add("active")}}closeArticleModal(){this.modalContent.style.transform="perspective(1000px) rotateY(90deg) scale(0.8)",setTimeout(()=>{this.modal.classList.remove("active"),document.body.style.overflow="",this.articleContent.innerHTML=""},300)}generateTOC(e){const n=e.querySelectorAll("h2, h3, h4"),t=document.getElementById("toc-nav");if(!t||n.length===0)return;t.innerHTML="",n.forEach((e,n)=>{const s=document.createElement("a");s.href=`#heading-${n}`,s.textContent=e.textContent,s.className=`toc-link toc-level-${e.tagName.toLowerCase()}`,e.id=`heading-${n}`,s.addEventListener("click",t=>{t.preventDefault(),e.scrollIntoView({behavior:"smooth"})}),t.appendChild(s)})}setupSearch(){const t=document.getElementById("search-input"),e=document.getElementById("search-results");if(!t||!e)return;let n;t.addEventListener("input",t=>{clearTimeout(n);const s=t.target.value.trim();if(s.length<2){e.style.display="none";return}n=setTimeout(()=>{this.performSearch(s,e)},300)}),document.addEventListener("click",t=>{t.target.closest(".nav-search")||(e.style.display="none")})}async performSearch(e,t){try{const e=[{title:"示例文章 1",url:"/posts/example1",excerpt:"这是示例文章的摘要..."},{title:"示例文章 2",url:"/posts/example2",excerpt:"这是另一篇示例文章的摘要..."}];t.innerHTML="",e.forEach(e=>{const n=document.createElement("div");n.className="search-result-item",n.innerHTML=`
                    <h4>${e.title}</h4>
                    <p>${e.excerpt}</p>
                `,n.addEventListener("click",()=>{window.location.href=e.url}),t.appendChild(n)}),t.style.display="block"}catch(e){console.error("搜索失败:",e)}}setupTOC(){const e=document.createElement("button");e.className="toc-toggle",e.innerHTML="目录",e.style.cssText=`
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: var(--transition-normal);
        `,document.body.appendChild(e);const t=document.getElementById("toc-modal"),n=document.getElementById("toc-close");t&&(e.addEventListener("click",()=>{t.classList.add("active")}),n.addEventListener("click",()=>{t.classList.remove("active")}))}smoothScroll(){document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=document.querySelector(this.getAttribute("href"));t&&t.scrollIntoView({behavior:"smooth",block:"start"})})})}}class SearchEngine{constructor(){this.index=new Map,this.init()}async init(){await this.buildIndex()}async buildIndex(){const e=document.querySelectorAll(".post-card");e.forEach(e=>{const t=e.querySelector(".card-title").textContent,n=e.querySelector(".card-excerpt").textContent,s=Array.from(e.querySelectorAll(".card-tag")).map(e=>e.textContent);this.index.set(e.dataset.post,{title:t.toLowerCase(),excerpt:n.toLowerCase(),tags:s.map(e=>e.toLowerCase())})})}search(e){e=e.toLowerCase();const t=[];for(const[o,s]of this.index){let n=0;s.title.includes(e)&&(n+=3),s.excerpt.includes(e)&&(n+=2),s.tags.some(t=>t.includes(e))&&(n+=1),n>0&&t.push({id:o,score:n,...s})}return t.sort((e,t)=>t.score-e.score)}}document.addEventListener("DOMContentLoaded",()=>{new RibooApp,new SearchEngine}),document.addEventListener("mousemove",e=>{const t=document.querySelectorAll(".post-card");t.forEach(t=>{const n=t.getBoundingClientRect(),s=e.clientX-n.left,o=e.clientY-n.top;if(s>=0&&s<=n.width&&o>=0&&o<=n.height){const e=n.width/2,i=n.height/2,a=(s-e)/e,r=(o-i)/i,c=50+a*25,l=50+r*25;t.style.setProperty("--light-x",`${c}%`),t.style.setProperty("--light-y",`${l}%`)}})})